---
phase: 01-core-display-manual-control
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - index.html
  - styles.css
  - script.js
autonomous: true

must_haves:
  truths:
    - "User can start and pause scrolling with a button"
    - "User can adjust scroll speed with +/- buttons"
    - "User can adjust text size with +/- buttons"
    - "User can enter fullscreen mode"
    - "User can exit back to editor mode"
    - "Settings persist across page refresh"
  artifacts:
    - path: "script.js"
      provides: "Complete scrolling loop and controls"
      contains: "requestAnimationFrame"
    - path: "index.html"
      provides: "Control buttons in overlay"
      contains: "controls-overlay"
    - path: "styles.css"
      provides: "Control button styling"
      contains: "control-btn"
  key_links:
    - from: "script.js scrollLoop"
      to: "state.scrollSpeed"
      via: "deltaTime calculation"
      pattern: "scrollSpeed.*deltaTime|deltaTime.*scrollSpeed"
    - from: "script.js"
      to: "localStorage"
      via: "settings persistence"
      pattern: "localStorage\\.(get|set)Item"
    - from: "script.js"
      to: "Fullscreen API"
      via: "requestFullscreen"
      pattern: "requestFullscreen|exitFullscreen"
---

<objective>
Complete the manual teleprompter by adding scrolling, controls, fullscreen, and settings persistence.

Purpose: Transform the static display into a fully functional manual teleprompter. User can control scrolling speed, text size, enter fullscreen, and their preferences are remembered.

Output: Complete Phase 1 deliverable - a professional manual teleprompter ready for use.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-display-manual-control/01-CONTEXT.md
@.planning/phases/01-core-display-manual-control/01-RESEARCH.md
@.planning/phases/01-core-display-manual-control/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add control buttons to HTML and style them</name>
  <files>index.html, styles.css</files>
  <action>
Update index.html - add control buttons inside `.controls-overlay`:

```html
<div class="controls-overlay">
  <div class="controls-row">
    <button id="exit-btn" class="control-btn">Exit</button>

    <div class="control-group">
      <button id="speed-down" class="control-btn">Speed -</button>
      <span id="speed-display" class="control-value">50</span>
      <button id="speed-up" class="control-btn">Speed +</button>
    </div>

    <button id="play-pause-btn" class="control-btn control-btn-primary">Play</button>

    <div class="control-group">
      <button id="size-down" class="control-btn">Text -</button>
      <span id="size-display" class="control-value">48</span>
      <button id="size-up" class="control-btn">Text +</button>
    </div>

    <button id="fullscreen-btn" class="control-btn">Fullscreen</button>
  </div>
</div>
```

Update styles.css - add control styling:

1. `.controls-row`: flexbox, justify-content space-between, align-items center, padding
2. `.control-group`: flexbox for grouping +/- with display value
3. `.control-btn`:
   - Background: rgba(255,255,255,0.1)
   - Border: 1px solid rgba(255,255,255,0.3)
   - Color: white
   - Padding: 0.5rem 1rem
   - Border-radius: 4px
   - Cursor: pointer
   - Transition for hover
4. `.control-btn:hover`: slightly brighter background
5. `.control-btn-primary`: different color for Play/Pause (e.g., green-ish tint)
6. `.control-value`: display for current speed/size values

Also add cursor behavior:
- `.teleprompter-view.fullscreen-active`: cursor: none
- On mouse move, briefly show cursor (handled in JS)
  </action>
  <verify>Refresh browser, enter teleprompter mode, move mouse - should see control bar at bottom with styled buttons.</verify>
  <done>Control buttons visible in overlay, properly styled, layout responsive.</done>
</task>

<task type="auto">
  <name>Task 2: Implement scrolling loop and all controls</name>
  <files>script.js</files>
  <action>
Add to script.js:

1. **Scrolling loop** (from RESEARCH.md Pattern 2):
```javascript
let lastTimestamp = null;
let animationId = null;

function scrollLoop(timestamp) {
  if (!lastTimestamp) lastTimestamp = timestamp;

  const deltaTime = timestamp - lastTimestamp;
  const pixelsToScroll = (state.scrollSpeed * deltaTime) / 1000;

  const container = document.getElementById('teleprompter-container');
  container.scrollTop += pixelsToScroll;

  lastTimestamp = timestamp;

  if (state.isScrolling) {
    animationId = requestAnimationFrame(scrollLoop);
  }
}

function startScrolling() {
  state.isScrolling = true;
  lastTimestamp = null;
  animationId = requestAnimationFrame(scrollLoop);
  updatePlayPauseButton();
}

function stopScrolling() {
  state.isScrolling = false;
  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
  }
  updatePlayPauseButton();
}

function toggleScrolling() {
  if (state.isScrolling) {
    stopScrolling();
  } else {
    startScrolling();
  }
}
```

2. **Speed controls** (from RESEARCH.md):
```javascript
const MIN_SPEED = 10;
const MAX_SPEED = 200;
const SPEED_INCREMENT = 10;

function increaseSpeed() {
  if (state.scrollSpeed < MAX_SPEED) {
    state.scrollSpeed += SPEED_INCREMENT;
    updateSpeedDisplay();
  }
}

function decreaseSpeed() {
  if (state.scrollSpeed > MIN_SPEED) {
    state.scrollSpeed -= SPEED_INCREMENT;
    updateSpeedDisplay();
  }
}
```

3. **Font size controls**:
```javascript
const MIN_FONT_SIZE = 24;
const MAX_FONT_SIZE = 96;
const FONT_INCREMENT = 4;

function increaseFontSize() {
  if (state.fontSize < MAX_FONT_SIZE) {
    state.fontSize += FONT_INCREMENT;
    applyFontSize();
    updateSizeDisplay();
  }
}

function decreaseFontSize() {
  if (state.fontSize > MIN_FONT_SIZE) {
    state.fontSize -= FONT_INCREMENT;
    applyFontSize();
    updateSizeDisplay();
  }
}

function applyFontSize() {
  document.getElementById('teleprompter-text').style.fontSize = state.fontSize + 'px';
}
```

4. **Fullscreen toggle** (from RESEARCH.md Pattern 4):
```javascript
async function toggleFullscreen() {
  // Blur any focused element first (iOS keyboard issue)
  if (document.activeElement) {
    document.activeElement.blur();
  }

  try {
    if (!document.fullscreenElement) {
      await document.documentElement.requestFullscreen();
    } else {
      await document.exitFullscreen();
    }
  } catch (error) {
    console.error('Fullscreen error:', error);
    // Graceful fallback - just continue without fullscreen
  }
}

document.addEventListener('fullscreenchange', () => {
  const teleprompterView = document.getElementById('teleprompter-view');
  if (document.fullscreenElement) {
    teleprompterView.classList.add('fullscreen-active');
  } else {
    teleprompterView.classList.remove('fullscreen-active');
  }
  updateFullscreenButton();
});
```

5. **Auto-hide overlay** (from RESEARCH.md Pattern 3):
```javascript
let hideTimeout = null;
let ticking = false;

function showControls() {
  const overlay = document.querySelector('.controls-overlay');
  overlay.classList.add('visible');

  clearTimeout(hideTimeout);
  hideTimeout = setTimeout(() => {
    if (state.mode === 'teleprompter') {
      overlay.classList.remove('visible');
    }
  }, 3000);
}

document.addEventListener('mousemove', () => {
  if (state.mode !== 'teleprompter') return;

  if (!ticking) {
    requestAnimationFrame(() => {
      showControls();
      ticking = false;
    });
    ticking = true;
  }
});

// Also show on touch for mobile
document.addEventListener('touchstart', showControls);
```

6. **Wire up all button event listeners**:
- Exit button -> switchMode('editor')
- Play/Pause -> toggleScrolling()
- Speed +/- -> increaseSpeed()/decreaseSpeed()
- Text +/- -> increaseFontSize()/decreaseFontSize()
- Fullscreen -> toggleFullscreen()

7. **Update display functions** for speed/size values and button text (Play/Pause, Enter/Exit Fullscreen).

8. **Update switchMode()**:
- When entering teleprompter: show controls briefly, apply font size
- When exiting: stop scrolling if active

9. **localStorage persistence** (from RESEARCH.md Pattern 5):
```javascript
const SETTINGS_KEY = 'teleprompter-settings';

function saveSettings() {
  const settings = {
    scrollSpeed: state.scrollSpeed,
    fontSize: state.fontSize
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
}

function loadSettings() {
  try {
    const saved = localStorage.getItem(SETTINGS_KEY);
    if (saved) {
      const settings = JSON.parse(saved);
      state.scrollSpeed = settings.scrollSpeed ?? 50;
      state.fontSize = settings.fontSize ?? 48;
    }
  } catch (e) {
    console.error('Failed to load settings:', e);
  }
}

// Subscribe to state changes for auto-save
subscribe((property) => {
  if (['scrollSpeed', 'fontSize'].includes(property)) {
    saveSettings();
  }
});

// Load on init
loadSettings();
```

Update displays after loading settings.
  </action>
  <verify>
1. Open in browser, paste text, enter teleprompter
2. Click Play - text should scroll smoothly
3. Click Pause - scrolling stops
4. Click Speed +/- - speed changes (visible in scroll rate)
5. Click Text +/- - text size changes
6. Click Fullscreen - enters fullscreen
7. Press Esc - exits fullscreen
8. Click Exit - returns to editor
9. Refresh page - settings should persist
  </verify>
  <done>All controls functional: play/pause, speed, text size, fullscreen, exit. Settings persist in localStorage.</done>
</task>

<task type="auto">
  <name>Task 3: Add keyboard shortcuts and polish</name>
  <files>script.js</files>
  <action>
Add keyboard shortcuts for teleprompter mode:

```javascript
document.addEventListener('keydown', (e) => {
  if (state.mode !== 'teleprompter') return;

  switch (e.code) {
    case 'Space':
      e.preventDefault(); // Prevent page scroll
      toggleScrolling();
      break;
    case 'ArrowUp':
      e.preventDefault();
      increaseSpeed();
      break;
    case 'ArrowDown':
      e.preventDefault();
      decreaseSpeed();
      break;
    case 'Equal': // + key
    case 'NumpadAdd':
      increaseFontSize();
      break;
    case 'Minus':
    case 'NumpadSubtract':
      decreaseFontSize();
      break;
    case 'KeyF':
      toggleFullscreen();
      break;
    case 'Escape':
      // If not in fullscreen, exit to editor
      if (!document.fullscreenElement) {
        switchMode('editor');
      }
      // If in fullscreen, browser handles exit
      break;
  }
});
```

Also briefly show controls when any key is pressed (user feedback).

Polish:
- Ensure scrollTop doesn't go negative
- Check for end of text (stop scrolling when reached bottom)
- Add padding at bottom of teleprompter text so last lines can scroll to reading position
  </action>
  <verify>
1. Enter teleprompter mode
2. Press Space - toggles play/pause
3. Press Up/Down arrows - adjusts speed
4. Press +/- keys - adjusts text size
5. Press F - toggles fullscreen
6. Press Escape (not in fullscreen) - exits to editor
7. Scroll to end of text - scrolling should stop gracefully
  </verify>
  <done>Keyboard shortcuts working, edge cases handled, polish complete.</done>
</task>

</tasks>

<verification>
Complete Phase 1 verification:

1. **DISP-01** (paste script): User can paste text in editor textarea
2. **DISP-02** (start/pause scrolling): Play/Pause button and Space key work
3. **DISP-03** (adjust speed): Speed +/- buttons and arrow keys work
4. **DISP-04** (adjust text size): Text +/- buttons and +/- keys work
5. **DISP-05** (broadcast style): Black background, white text, left-aligned
6. **DISP-06** (fullscreen): Fullscreen button and F key work

Additional checks:
- Controls auto-hide after 3 seconds of inactivity
- Controls appear on mouse move or touch
- Settings persist after page refresh
- Exit button returns to editor
- Scrolling is smooth (60 FPS)
- Reading marker visible at top third
</verification>

<success_criteria>
- All 6 DISP-* requirements met
- Smooth scrolling using requestAnimationFrame
- Auto-hiding control overlay
- Keyboard shortcuts functional
- localStorage persistence working
- No JavaScript errors in console
- Fullscreen works (or gracefully degrades)
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-display-manual-control/01-02-SUMMARY.md`
</output>
