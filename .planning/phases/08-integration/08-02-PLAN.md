---
phase: 08-integration
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - script.js
  - index.html
  - styles.css
autonomous: false

must_haves:
  truths:
    - "Debug overlay toggles with Ctrl+Shift+D (Windows/Linux) or Cmd+Shift+D (Mac)"
    - "Export State button copies JSON to clipboard"
    - "Caret slider updates caret line position"
    - "User can read entire script naturally with voice mode"
  artifacts:
    - path: "script.js"
      provides: "Debug toggle and state export functions"
      contains: "toggleDebugMode|exportDebugState"
    - path: "index.html"
      provides: "Export state button in debug overlay"
      contains: "export-state-btn"
    - path: "styles.css"
      provides: "Export button styling"
      contains: "export-state-btn|debug-btn"
  key_links:
    - from: "document keydown listener"
      to: "toggleDebugMode function"
      via: "Ctrl+Shift+D detection"
      pattern: "(ctrlKey|metaKey).*shiftKey.*KeyD"
    - from: "export-state-btn click"
      to: "exportDebugState function"
      via: "addEventListener"
      pattern: "export-state-btn.*addEventListener"
    - from: "caret-slider input"
      to: "scrollController.setCaretPercent"
      via: "event listener"
      pattern: "caret-slider.*scrollController"
---

<objective>
Add debug overlay features and verify end-to-end pipeline functionality

Purpose: Complete the debug observability features (keyboard shortcut toggle, state export, caret slider wiring) and perform human verification that the entire v1.1 pipeline works naturally when reading a script.

Output: Production-ready debug overlay and verified end-to-end voice-controlled teleprompter.
</objective>

<execution_context>
@/Users/brent/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-integration/08-CONTEXT.md
@.planning/phases/08-integration/08-RESEARCH.md
@.planning/phases/08-integration/08-01-SUMMARY.md
@script.js
@index.html
@styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add debug overlay features</name>
  <files>
    script.js
    index.html
    styles.css
  </files>
  <action>
Implement debug overlay enhancements per user decisions from 08-CONTEXT.md:
- Access via keyboard shortcut (not settings panel)
- Console logging silent in production
- Export state button copies JSON to clipboard

**1. Add keyboard shortcut handler in script.js:**

Find the existing keydown event listener (around line 690-720) and add debug toggle at the START of the handler:

```javascript
document.addEventListener('keydown', (e) => {
  // Debug overlay toggle: Ctrl+Shift+D (Windows/Linux) or Cmd+Shift+D (Mac)
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.code === 'KeyD') {
    e.preventDefault();
    toggleDebugMode();
    return;
  }

  // ... existing teleprompter mode shortcuts
});
```

**2. Add toggleDebugMode function in script.js (near other debug functions):**

```javascript
function toggleDebugMode() {
  debugMode = !debugMode;

  if (debugOverlay) {
    debugOverlay.classList.toggle('hidden', !debugMode);
  }

  if (debugMode) {
    startDebugUpdates();
    console.log('[Debug] Mode enabled - Ctrl+Shift+D to toggle');
  } else {
    stopDebugUpdates();
  }
}

function startDebugUpdates() {
  if (debugUpdateInterval) return;
  debugUpdateInterval = setInterval(updateDebugOverlay, 100);
}

function stopDebugUpdates() {
  if (debugUpdateInterval) {
    clearInterval(debugUpdateInterval);
    debugUpdateInterval = null;
  }
}
```

NOTE: debugMode and debugUpdateInterval should already exist from Plan 01. If not, add them at module level.

**3. Add Export State button to index.html:**

Find the debug-overlay div (around line 68-119) and add the export button after the caret slider section:

```html
<!-- Add after the caret-setting div, before closing </div> of debug-overlay -->
<button id="export-state-btn" class="debug-btn">Export State</button>
```

**4. Add exportDebugState function in script.js:**

```javascript
async function exportDebugState() {
  const stateSnapshot = {
    timestamp: new Date().toISOString(),
    version: '1.1',

    position: positionTracker ? {
      confirmed: positionTracker.getConfirmedPosition(),
      candidate: positionTracker.candidatePosition,
      consecutiveCount: positionTracker.consecutiveMatchCount
    } : null,

    scroll: scrollController ? {
      isTracking: scrollController.isTracking,
      speakingPace: scrollController.speakingPace,
      caretPercent: scrollController.caretPercent,
      currentScroll: teleprompterContainer?.scrollTop || 0
    } : null,

    speech: {
      enabled: state.voiceEnabled,
      state: state.voiceState
    },

    script: matcher ? {
      totalWords: matcher.scriptWords.length
    } : null,

    settings: {
      fontSize: state.fontSize,
      highlightEnabled: state.highlightEnabled
    }
  };

  try {
    const json = JSON.stringify(stateSnapshot, null, 2);
    await navigator.clipboard.writeText(json);
    showExportSuccess();
  } catch (err) {
    console.error('Clipboard write failed:', err);
    // Fallback: log to console for manual copy
    console.log('Debug state (copy manually):\n', JSON.stringify(stateSnapshot, null, 2));
    showExportFallback();
  }
}

function showExportSuccess() {
  const btn = document.getElementById('export-state-btn');
  if (btn) {
    const original = btn.textContent;
    btn.textContent = 'Copied!';
    btn.classList.add('success');
    setTimeout(() => {
      btn.textContent = original;
      btn.classList.remove('success');
    }, 1500);
  }
}

function showExportFallback() {
  const btn = document.getElementById('export-state-btn');
  if (btn) {
    btn.textContent = 'See Console';
    setTimeout(() => {
      btn.textContent = 'Export State';
    }, 2000);
  }
}
```

**5. Wire export button in DOMContentLoaded (add near other event listeners):**

```javascript
document.getElementById('export-state-btn')?.addEventListener('click', exportDebugState);
```

**6. Wire caret slider to ScrollController:**

Find or add the caret-slider event listener:

```javascript
document.getElementById('caret-slider')?.addEventListener('input', (e) => {
  const value = parseInt(e.target.value, 10);

  // Update display
  const valueDisplay = document.getElementById('caret-value');
  if (valueDisplay) valueDisplay.textContent = `${value}%`;

  // Update caret line visual position
  const caretLine = document.getElementById('caret-line');
  if (caretLine) caretLine.style.top = `${value}%`;

  // Update ScrollController (if initialized)
  if (scrollController && scrollController.setCaretPercent) {
    scrollController.setCaretPercent(value);
  }
});
```

**7. Add CSS for export button in styles.css:**

Find the debug overlay styles section and add:

```css
.debug-btn {
  background: #333;
  color: #0f0;
  border: 1px solid #0f0;
  padding: 6px 12px;
  margin-top: 8px;
  cursor: pointer;
  font-family: monospace;
  font-size: 12px;
  width: 100%;
}

.debug-btn:hover {
  background: #0f0;
  color: #000;
}

.debug-btn.success {
  background: #0a0;
  border-color: #0f0;
}
```

**8. Remove or disable v1.0 tuning controls (optional cleanup):**

The tune-* inputs in the debug overlay are v1.0 specific. Options:
- Leave them (harmless, scrollSync is null so they do nothing)
- Comment out in HTML (cleaner)
- Add note that they're deprecated

Recommended: Add a comment in HTML around the tune-row divs:
```html
<!-- v1.0 tuning controls - deprecated in v1.1 -->
```

**9. Commit the changes:**

```bash
git add script.js index.html styles.css
git commit -m "feat(08): add debug overlay features

- Add Ctrl+Shift+D / Cmd+Shift+D keyboard shortcut for debug toggle
- Add Export State button with clipboard API (fallback to console)
- Wire caret slider to ScrollController.setCaretPercent
- Add CSS for debug button states
- Debug logging only outputs when debugMode is true

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
  </action>
  <verify>
```bash
# Check for syntax errors
node --check script.js

# Verify keyboard shortcut handler exists
grep -n "ctrlKey.*metaKey.*shiftKey.*KeyD" script.js

# Verify export button in HTML
grep -n "export-state-btn" index.html

# Verify export function exists
grep -n "exportDebugState" script.js

# Verify caret slider wiring
grep -n "caret-slider.*addEventListener" script.js
```
  </verify>
  <done>
Debug overlay features complete:
- Keyboard shortcut (Ctrl+Shift+D / Cmd+Shift+D) toggles overlay
- Export State button copies JSON to clipboard
- Caret slider updates both visual position and ScrollController
- Debug logging is silent unless debugMode is true
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification</name>
  <what-built>
Complete v1.1 pipeline integration:
- Deleted old components (TextMatcher, ScrollSync, ConfidenceLevel)
- Wired new pipeline (WordMatcher -> PositionTracker -> ScrollController)
- Added debug overlay with keyboard shortcut, state export, and caret slider
  </what-built>
  <how-to-verify>
**Setup:**
1. Open the teleprompter in browser (Live Server or `npx serve`)
2. Enter a test script (or use existing sample text)
3. Click "Start Teleprompter" to enter teleprompter mode

**Test 1: Debug Overlay Toggle**
1. Press Ctrl+Shift+D (Windows/Linux) or Cmd+Shift+D (Mac)
2. Verify debug overlay appears
3. Press again to hide
4. Expected: Overlay toggles visibility

**Test 2: State Export**
1. Enable debug overlay (Ctrl+Shift+D)
2. Enable voice mode (click Voice button)
3. Click "Export State" button
4. Paste into a text editor
5. Expected: Valid JSON with position, scroll, speech, script sections

**Test 3: Caret Slider**
1. Enable debug overlay
2. Drag caret slider to different values (e.g., 50%)
3. Observe the caret line on screen
4. Expected: Caret line moves to match slider percentage

**Test 4: Voice Pipeline (Core Verification)**
1. Click Voice button to enable voice mode
2. Allow microphone access if prompted
3. Read the script text out loud, naturally
4. Observe:
   - Tracking indicator shows "Tracking" (green) while speaking
   - Text highlights follow your speech
   - Scroll keeps pace with your reading
   - If you pause, indicator shows "Holding" (yellow)
5. Try skipping ahead 20+ words - observe it takes multiple matches to jump
6. Try reading back - observe position holds (no backward jump)
7. Expected: Teleprompter follows you naturally, confirms where you ARE

**Test 5: Reset**
1. Click Reset button
2. Verify scroll returns to top
3. Verify tracking indicator shows "Stopped"
4. Expected: Clean reset to initial state

**If issues found:**
- Check browser console for errors
- Use Export State to capture current state
- Report specific failure (which test, what happened vs expected)
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Debug toggle works:** Ctrl+Shift+D shows/hides debug overlay
2. **State export works:** Export State button copies valid JSON to clipboard
3. **Caret slider works:** Slider updates both visual line and scroll behavior
4. **Voice pipeline works:** User can read script naturally with following behavior
5. **No console errors:** Browser dev tools shows no JavaScript errors during use
</verification>

<success_criteria>
Phase 8 Integration complete when:
- [ ] Old components removed (verified in Plan 01)
- [ ] New pipeline wired: SpeechRecognizer -> WordMatcher -> PositionTracker -> ScrollController
- [ ] Debug overlay accessible via keyboard shortcut
- [ ] State export functional
- [ ] Caret slider wired to ScrollController
- [ ] User has verified end-to-end natural reading experience
- [ ] v1.1 Following-Along Rewrite milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration/08-02-SUMMARY.md`
</output>
