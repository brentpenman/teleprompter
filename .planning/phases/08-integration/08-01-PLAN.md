---
phase: 08-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - matching/TextMatcher.js
  - matching/ScrollSync.js
  - matching/ConfidenceLevel.js
  - script.js
autonomous: true

must_haves:
  truths:
    - "Old components no longer exist on disk"
    - "New pipeline components imported and instantiated"
    - "Speech triggers matching through new pipeline"
    - "Position advances on confirmed match"
    - "Scroll responds to position changes"
  artifacts:
    - path: "script.js"
      provides: "v1.1 pipeline wiring"
      contains: "import { createMatcher, findMatches }"
    - path: "matching/TextMatcher.js"
      provides: "DELETED - must not exist"
      exists: false
    - path: "matching/ScrollSync.js"
      provides: "DELETED - must not exist"
      exists: false
    - path: "matching/ConfidenceLevel.js"
      provides: "DELETED - must not exist"
      exists: false
  key_links:
    - from: "script.js onTranscript callback"
      to: "WordMatcher.findMatches"
      via: "function call"
      pattern: "findMatches\\(text, matcher"
    - from: "script.js onTranscript callback"
      to: "PositionTracker.processMatch"
      via: "method call"
      pattern: "positionTracker\\.processMatch"
    - from: "script.js onTranscript callback"
      to: "ScrollController.onPositionAdvanced"
      via: "method call"
      pattern: "scrollController\\.onPositionAdvanced"
---

<objective>
Delete deprecated v1.0 components and wire v1.1 pipeline in script.js

Purpose: Replace stateful v1.0 matching system with clean v1.1 pipeline (SpeechRecognizer -> WordMatcher -> PositionTracker -> ScrollController). Uses "delete first" approach to force compile-time errors for any missed references.

Output: Working teleprompter with new pipeline; old files removed from disk.
</objective>

<execution_context>
@/Users/brent/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-integration/08-CONTEXT.md
@.planning/phases/08-integration/08-RESEARCH.md
@script.js
@matching/WordMatcher.js
@matching/PositionTracker.js
@matching/ScrollController.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete deprecated v1.0 components</name>
  <files>
    matching/TextMatcher.js
    matching/ScrollSync.js
    matching/ConfidenceLevel.js
  </files>
  <action>
Delete the three deprecated v1.0 files using git rm:

```bash
git rm matching/TextMatcher.js matching/ScrollSync.js matching/ConfidenceLevel.js
git commit -m "chore(08): remove deprecated v1.0 components

BREAKING: TextMatcher, ScrollSync, ConfidenceLevel removed
- Replaced by WordMatcher (Phase 5)
- Replaced by PositionTracker (Phase 6)
- Replaced by ScrollController (Phase 7)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

This creates a clean break point. Any references to old components will now cause import errors in script.js, making them easy to find and fix.
  </action>
  <verify>
```bash
# Verify files are gone
ls matching/TextMatcher.js matching/ScrollSync.js matching/ConfidenceLevel.js 2>&1
# Should show: "No such file or directory" for each

# Verify commit exists
git log --oneline -1
# Should show the chore commit
```
  </verify>
  <done>Three old files deleted and committed. Git history shows atomic removal commit.</done>
</task>

<task type="auto">
  <name>Task 2: Wire v1.1 pipeline in script.js</name>
  <files>script.js</files>
  <action>
Replace v1.0 matching system with v1.1 pipeline. Key changes:

**1. Replace module-level variables (around line 31-37):**

Replace:
```javascript
let TextMatcher = null;
let Highlighter = null;
let ScrollSync = null;
let textMatcher = null;
let highlighter = null;
let scrollSync = null;
```

With:
```javascript
// v1.1 pipeline components
import { createMatcher, findMatches } from './matching/WordMatcher.js';
import { PositionTracker } from './matching/PositionTracker.js';
import { ScrollController } from './matching/ScrollController.js';
import { Highlighter } from './matching/Highlighter.js';

let matcher = null;           // WordMatcher result (stateless)
let positionTracker = null;   // Stateful position
let scrollController = null;  // Reactive scroll
let highlighter = null;       // Kept from v1.0

// Debug mode (off by default, toggled via Ctrl+Shift+D)
let debugMode = false;
```

NOTE: Move imports to top of file (ES modules require imports at top level). The Highlighter import may need adjustment since it was dynamically imported before.

**2. Replace initMatchingSystem function (around line 497):**

Replace entire function with:
```javascript
async function initMatchingSystem(scriptText) {
  // Build stateless matcher for this script
  matcher = createMatcher(scriptText, { threshold: 0.3 });

  // Create stateful position tracker
  positionTracker = new PositionTracker({
    confidenceThreshold: 0.7,
    nearbyThreshold: 10,
    smallSkipConsecutive: 4,
    largeSkipConsecutive: 5
  });

  // Create reactive scroll controller
  scrollController = new ScrollController(
    teleprompterContainer,
    positionTracker,
    matcher.scriptWords.length,
    {
      caretPercent: 33, // Default, will be updated by slider
      holdTimeout: 5000,
      onStateChange: (scrollState) => {
        updateTrackingIndicator(scrollState);
        debugLog('[Scroll] State:', scrollState);
      }
    }
  );

  // Create highlighter (same as v1.0 but static import)
  highlighter = new Highlighter(teleprompterText, {
    phraseLength: 3,
    enabled: state.highlightEnabled
  });

  debugLog('[Pipeline] Initialized with', matcher.scriptWords.length, 'words');
}
```

**3. Add debug logging helper (near top after imports):**
```javascript
function debugLog(...args) {
  if (debugMode) {
    console.log('[Debug]', ...args);
  }
}
```

**4. Add tracking indicator update function:**
```javascript
function updateTrackingIndicator(scrollState) {
  const indicator = document.getElementById('tracking-indicator');
  if (!indicator) return;

  // Remove all state classes
  indicator.classList.remove('tracking', 'holding', 'stopped');

  // Add appropriate class and text
  if (scrollState === 'tracking') {
    indicator.classList.add('tracking');
    indicator.textContent = 'Tracking';
  } else if (scrollState === 'holding') {
    indicator.classList.add('holding');
    indicator.textContent = 'Holding';
  } else {
    indicator.classList.add('stopped');
    indicator.textContent = 'Stopped';
  }
}
```

**5. Extract speech callback to handleSpeechTranscript function and update enableVoiceMode:**

Add new function:
```javascript
function handleSpeechTranscript(text, isFinal) {
  if (!matcher || !positionTracker || !scrollController) {
    debugLog('[Pipeline] Components not ready');
    return;
  }

  debugLog('[Speech]', isFinal ? 'FINAL:' : 'interim:', text);

  // Get current position from PositionTracker
  const prevPosition = positionTracker.getConfirmedPosition();

  // Find matches using stateless WordMatcher
  const result = findMatches(text, matcher, prevPosition, {
    radius: 50,
    minConsecutive: 2,
    distanceWeight: 0.3
  });

  if (!result.bestMatch) {
    debugLog('[Pipeline] No match found');
    return;
  }

  debugLog('[Match]', {
    position: result.bestMatch.position,
    score: result.bestMatch.combinedScore.toFixed(3),
    distance: result.bestMatch.distance
  });

  // Process through PositionTracker
  const processResult = positionTracker.processMatch(result.bestMatch);

  debugLog('[Position]', processResult.action,
    processResult.action === 'advanced'
      ? `-> ${processResult.confirmedPosition}`
      : `(confirmed: ${processResult.confirmedPosition})`
  );

  if (processResult.action === 'advanced') {
    // Notify ScrollController
    scrollController.onPositionAdvanced(
      processResult.confirmedPosition,
      prevPosition
    );

    // Update highlight
    if (highlighter && state.highlightEnabled) {
      highlighter.highlightPosition(
        processResult.confirmedPosition,
        matcher.scriptWords
      );
    }

    // Update confidence indicator
    if (audioVisualizer) {
      audioVisualizer.setConfidenceLevel('high');
    }
  } else if (processResult.action === 'exploring') {
    // Show medium confidence during skip exploration
    if (audioVisualizer) {
      audioVisualizer.setConfidenceLevel('medium');
    }
  }
}
```

Update enableVoiceMode to use handleSpeechTranscript:
- Find the onTranscript callback in speechRecognizer initialization
- Replace entire callback with: `onTranscript: handleSpeechTranscript,`
- Add after speechRecognizer.start(): `if (scrollController) { scrollController.start(); }`

**6. Update disableVoiceMode:**
- Replace `if (scrollSync) { scrollSync.stop(); }` with `if (scrollController) { scrollController.stop(); }`

**7. Update resetTeleprompter:**
Replace the textMatcher/scrollSync reset block with:
```javascript
// Reset v1.1 pipeline components
if (positionTracker) {
  positionTracker.reset();
}
if (scrollController) {
  scrollController.reset();
}
if (highlighter) {
  highlighter.clear();
}
```

**8. Update updateDebugOverlay function:**
Replace old scrollSync.getState() calls with v1.1 equivalents:
```javascript
function updateDebugOverlay() {
  if (!debugOverlay) return;

  // Position info (from PositionTracker)
  const posInfo = positionTracker ? {
    confirmed: positionTracker.getConfirmedPosition(),
    total: matcher?.scriptWords.length || 0
  } : { confirmed: 0, total: 0 };

  document.getElementById('debug-position').textContent =
    `${posInfo.confirmed}/${posInfo.total}`;

  // Scroll info (from ScrollController)
  if (scrollController) {
    document.getElementById('debug-pace').textContent =
      scrollController.speakingPace?.toFixed(1) || '0';
    document.getElementById('debug-state').textContent =
      scrollController.isTracking ? 'tracking' : 'holding';
  }

  // Speed display
  if (teleprompterContainer) {
    document.getElementById('debug-speed').textContent =
      Math.round(teleprompterContainer.scrollTop);
  }

  // Target speed - use 0 or remove (v1.1 doesn't have this concept)
  const targetEl = document.getElementById('debug-target-speed');
  if (targetEl) targetEl.textContent = '-';
}
```

**9. Remove or update old tuning controls event listeners:**
The tune-* inputs (base-speed, behind-max, etc.) are v1.0 specific. Either:
- Remove the event listeners that call scrollSync.setTuning()
- Or leave them (they'll be harmless since scrollSync is null)

Safer approach: Comment out or remove the tuning listener block.

**10. Commit the changes:**
```bash
git add script.js
git commit -m "feat(08): wire v1.1 pipeline in script.js

- Import WordMatcher, PositionTracker, ScrollController statically
- Replace initMatchingSystem with v1.1 component initialization
- Add handleSpeechTranscript function for new pipeline flow
- Update enableVoiceMode to start ScrollController
- Update disableVoiceMode to stop ScrollController
- Update resetTeleprompter for v1.1 components
- Update debug overlay for v1.1 state
- Add debugLog helper (off by default)

Pipeline: Speech -> WordMatcher -> PositionTracker -> ScrollController

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
  </action>
  <verify>
```bash
# Check for syntax errors
node --check script.js

# Verify no references to old components remain
grep -n "TextMatcher\|ScrollSync\|ConfidenceLevel\|textMatcher\|scrollSync" script.js
# Should return nothing (or only comments if explaining the migration)

# Verify new imports exist
grep -n "import.*WordMatcher\|import.*PositionTracker\|import.*ScrollController" script.js
# Should show the import lines

# Start dev server and check browser console for errors
# (Manual check - open in browser, enable voice mode, speak test words)
```
  </verify>
  <done>
script.js uses v1.1 pipeline exclusively:
- WordMatcher for stateless matching
- PositionTracker for position confirmation
- ScrollController for reactive scrolling
- No references to TextMatcher, ScrollSync, or ConfidenceLevel
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Files deleted:** `ls matching/TextMatcher.js matching/ScrollSync.js matching/ConfidenceLevel.js` returns "No such file"
2. **New imports present:** `grep "import.*WordMatcher" script.js` returns import line
3. **Pipeline wired:** `grep "findMatches\|processMatch\|onPositionAdvanced" script.js` shows all three calls in handleSpeechTranscript
4. **No syntax errors:** `node --check script.js` exits 0
5. **Git history clean:** `git log --oneline -2` shows both commits
</verification>

<success_criteria>
- Old v1.0 components (TextMatcher.js, ScrollSync.js, ConfidenceLevel.js) deleted from disk
- script.js imports and uses v1.1 components exclusively
- Pipeline flow: SpeechRecognizer -> WordMatcher -> PositionTracker -> ScrollController
- No JavaScript syntax errors
- Two atomic commits: one for deletion, one for wiring
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration/08-01-SUMMARY.md`
</output>
