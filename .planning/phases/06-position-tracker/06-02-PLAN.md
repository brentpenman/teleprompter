---
phase: 06-position-tracker
plan: 02
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - matching/PositionTracker.js
  - matching/PositionTracker.test.js
autonomous: true

must_haves:
  truths:
    - "Skip 20+ words ahead requires consecutive matching words before position jumps"
    - "Small skip (10-30 words) requires 4 consecutive matches"
    - "Large skip (50+ words) requires 5-6 consecutive matches"
    - "Partial streak (< required) keeps position at confirmed floor"
    - "Completed streak jumps confirmedPosition to new location"
  artifacts:
    - path: "matching/PositionTracker.js"
      provides: "Skip detection with distance-dependent consecutive matching"
      exports: ["PositionTracker"]
      contains: "consecutiveMatchCount"
    - path: "matching/PositionTracker.test.js"
      provides: "Skip confirmation tests"
      contains: "consecutive"
  key_links:
    - from: "matching/PositionTracker.js"
      to: "getRequiredConsecutive"
      via: "distance-based threshold calculation"
      pattern: "getRequiredConsecutive.*distance"
---

<objective>
Add skip detection with distance-dependent consecutive word matching. When user skips ahead in the script, require multiple consecutive matches before confirming the jump.

Purpose: Prevents false jumps on repeated phrases. The distance-weighted scoring from WordMatcher helps, but consecutive confirmation provides additional safety. This completes the PositionTracker for Phase 6 success criteria.

Output: Complete PositionTracker with skip detection, passing all TDD tests for both nearby and skip scenarios.
</objective>

<execution_context>
@/Users/brent/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-position-tracker/06-CONTEXT.md
@.planning/phases/06-position-tracker/06-RESEARCH.md
@.planning/phases/06-position-tracker/06-01-SUMMARY.md

@matching/PositionTracker.js
@matching/PositionTracker.test.js
</context>

<feature>
  <name>Skip Detection with Consecutive Match Confirmation</name>
  <files>matching/PositionTracker.js, matching/PositionTracker.test.js</files>
  <behavior>
    Skip detection adds distance-dependent consecutive matching:

    Distance thresholds (from CONTEXT.md):
    - distance <= 10 words (nearbyThreshold): require 1 match (normal tracking)
    - distance 10-50 words (small skip): require 4 consecutive matches
    - distance > 50 words (large skip): require 5 consecutive matches

    Consecutive tracking:
    - Track lastMatchEndPosition to detect consecutive matches
    - Match is consecutive if startPosition is within 2 words of lastMatchEndPosition
      (allows gap for filler word filtering)
    - Reset streak when match is not consecutive
    - Advance confirmedPosition only when streak >= required

    New constructor options:
    - smallSkipConsecutive (default: 4)
    - largeSkipConsecutive (default: 5)

    ProcessResult for exploring state:
    { action: 'exploring', confirmedPosition, candidatePosition, consecutiveCount, requiredCount }

    Test cases:
    - SKIP_1_OF_4: position jumps 25 words, 1st consecutive match -> exploring (1/4)
    - SKIP_2_OF_4: 2nd consecutive match at +26 -> exploring (2/4)
    - SKIP_3_OF_4: 3rd consecutive match at +27 -> exploring (3/4)
    - SKIP_4_OF_4: 4th consecutive match at +28 -> advanced (confirmed!)
    - SKIP_LARGE: position jumps 60 words -> requires 5 consecutive
    - STREAK_BROKEN: non-consecutive match resets streak to 1
    - NEARBY_STILL_WORKS: small distance still requires only 1 match
  </behavior>
  <implementation>
    1. Add failing tests for skip scenarios:
       - Small skip (25 words): requires 4 consecutive before confirming
       - Large skip (60 words): requires 5 consecutive before confirming
       - Broken streak: non-consecutive resets counter
       - Nearby unchanged: distance <= 10 still confirms immediately

    2. Extend PositionTracker to pass tests:
       - Add consecutiveMatchCount, lastMatchEndPosition properties
       - Add isConsecutiveMatch(candidate) method
       - Add getRequiredConsecutive(distance) method
       - Add resetStreak() method
       - Modify processMatch to check consecutive requirement for distant matches
       - Return exploring action with streak counts when building toward skip

    3. Update JSDoc types:
       - Add @typedef for extended ProcessResult
       - Document new options and methods
  </implementation>
</feature>

<verification>
```bash
# Run tests
npm test -- matching/PositionTracker.test.js

# Verify skip detection
npm test -- matching/PositionTracker.test.js --testNamePattern="skip|consecutive"

# Count tests (should be 10+)
npm test -- matching/PositionTracker.test.js --json 2>/dev/null | grep -o '"numPassedTests":[0-9]*'
```
</verification>

<success_criteria>
- Skip detection tests added (4+ new tests)
- All tests pass (10+ total)
- Small skip (10-50 words) requires 4 consecutive matches
- Large skip (50+ words) requires 5 consecutive matches
- Nearby matches (<=10 words) still confirm with 1 match
- Streak counter resets on non-consecutive match
- Phase 6 success criteria met:
  1. confirmedPosition only moves forward
  2. High-confidence match advances position
  3. Skip 20+ words requires consecutive confirmation
  4. Backward matches ignored
  5. getScrollBoundary available for external code
</success_criteria>

<output>
After completion, create `.planning/phases/06-position-tracker/06-02-SUMMARY.md`
</output>
