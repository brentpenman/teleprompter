---
phase: 04-intelligent-scroll-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - matching/ConfidenceLevel.js
  - voice/AudioVisualizer.js
autonomous: true

must_haves:
  truths:
    - "Confidence calculator produces high/medium/low levels from match data"
    - "AudioVisualizer brightness reflects current confidence level"
  artifacts:
    - path: "matching/ConfidenceLevel.js"
      provides: "Compound confidence calculation"
      exports: ["ConfidenceCalculator"]
    - path: "voice/AudioVisualizer.js"
      provides: "Confidence opacity modulation"
      contains: "setConfidenceLevel"
  key_links:
    - from: "matching/ConfidenceLevel.js"
      to: "Fuse.js scores"
      via: "invertFuseScore method"
      pattern: "1 - .*score"
    - from: "voice/AudioVisualizer.js"
      to: "globalAlpha"
      via: "canvas context"
      pattern: "globalAlpha"
---

<objective>
Create compound confidence scoring and visual confidence feedback

Purpose: Enable the system to calculate how confident it is in position matches (using Fuse.js scores, consecutive matches, and recency) and display this confidence visually through the AudioVisualizer's brightness.

Output: ConfidenceLevel.js with compound confidence calculation, AudioVisualizer.js with opacity modulation based on confidence levels
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-intelligent-scroll-control/04-CONTEXT.md
@.planning/phases/04-intelligent-scroll-control/04-RESEARCH.md
@voice/AudioVisualizer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConfidenceLevel.js compound confidence calculator</name>
  <files>matching/ConfidenceLevel.js</files>
  <action>
Create a new ES module `matching/ConfidenceLevel.js` with a ConfidenceCalculator class:

1. **Constructor options:**
   - `highThreshold`: 0.7 (default) - above this is HIGH confidence
   - `lowThreshold`: 0.4 (default) - below this is LOW confidence
   - `matchScoreWeight`: 0.5 - weight for Fuse.js match quality
   - `consecutiveWeight`: 0.3 - weight for consecutive match ratio
   - `recencyWeight`: 0.2 - weight for time since last match

2. **Methods:**
   - `invertFuseScore(fuseScore)`: Convert Fuse.js score (0=perfect, 1=bad) to confidence (0=bad, 1=perfect). Formula: `1 - Math.min(fuseScore, 1)`
   - `calculate(fuseScore, consecutiveMatches, windowSize, msSinceLastMatch)`: Return raw confidence 0-1 using weighted combination:
     - matchQuality = invertFuseScore(fuseScore)
     - consecutiveRatio = consecutiveMatches / windowSize
     - recencyFactor = Math.max(0, 1 - (msSinceLastMatch / 5000)) // decays over 5 seconds
     - return weighted sum
   - `toLevel(rawConfidence)`: Return 'high', 'medium', or 'low' based on thresholds

3. **Export:** Named export `ConfidenceCalculator`

Reference RESEARCH.md Pattern 1 for the implementation pattern.
  </action>
  <verify>
File exists at matching/ConfidenceLevel.js with:
- ConfidenceCalculator class exported
- invertFuseScore, calculate, and toLevel methods present
- Default thresholds: high=0.7, low=0.4
  </verify>
  <done>
ConfidenceCalculator correctly inverts Fuse.js scores and produces high/medium/low confidence levels from compound signals
  </done>
</task>

<task type="auto">
  <name>Task 2: Add confidence opacity modulation to AudioVisualizer</name>
  <files>voice/AudioVisualizer.js</files>
  <action>
Extend the existing AudioVisualizer class to modulate bar brightness based on confidence:

1. **Add state properties in constructor:**
   - `this.confidenceLevel = 'high'` - current confidence level ('high', 'medium', 'low')
   - `this.currentOpacity = 1.0` - current opacity (for smooth transitions)

2. **Add setConfidenceLevel(level) method:**
   - Sets `this.confidenceLevel` to the provided level
   - Level must be 'high', 'medium', or 'low'

3. **Modify draw() method:**
   - Before drawing bars, calculate target opacity based on confidence:
     - 'high': 1.0
     - 'medium': 0.6
     - 'low': 0.3
   - Smooth transition: `this.currentOpacity += (targetOpacity - this.currentOpacity) * 0.1`
   - Apply opacity: `this.ctx.globalAlpha = this.currentOpacity`
   - IMPORTANT: Reset globalAlpha to 1.0 at the END of draw() to avoid affecting other canvas operations if any

4. **Keep existing setErrorState() method unchanged** - error state still changes color, confidence changes brightness

5. **In stop() method:** Reset `this.confidenceLevel = 'high'` and `this.currentOpacity = 1.0`

Reference RESEARCH.md Pattern 5 for the canvas opacity pattern.
  </action>
  <verify>
In AudioVisualizer.js:
- setConfidenceLevel method exists and accepts 'high', 'medium', 'low'
- draw() method uses globalAlpha based on confidence level
- Opacity smoothly transitions (0.1 blend factor)
- stop() resets confidence state
  </verify>
  <done>
AudioVisualizer brightness dims to 60% for medium confidence and 30% for low confidence, with smooth transitions between levels
  </done>
</task>

</tasks>

<verification>
1. ConfidenceLevel.js exports ConfidenceCalculator class
2. `new ConfidenceCalculator().toLevel(new ConfidenceCalculator().calculate(0.1, 2, 3, 100))` returns 'high'
3. `new ConfidenceCalculator().toLevel(new ConfidenceCalculator().calculate(0.5, 1, 3, 3000))` returns 'medium' or 'low'
4. AudioVisualizer.setConfidenceLevel exists and draw() uses globalAlpha
</verification>

<success_criteria>
- ConfidenceCalculator produces consistent high/medium/low levels from test inputs
- AudioVisualizer can be set to different confidence levels
- No breaking changes to existing AudioVisualizer functionality (error state still works)
</success_criteria>

<output>
After completion, create `.planning/phases/04-intelligent-scroll-control/04-01-SUMMARY.md`
</output>
