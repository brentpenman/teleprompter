---
phase: 11-engine-selection-polish
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - index.html
  - script.js
  - styles.css
  - ui/SettingsPanel.js
  - ui/LoadingStates.js
autonomous: true

must_haves:
  truths:
    - "User can select recognition engine from settings UI"
    - "App displays current engine in use"
    - "App shows model download progress during Vosk initialization"
    - "App displays model cache status and last updated date"
    - "Switching engines preserves script content and position"
  artifacts:
    - path: "ui/SettingsPanel.js"
      provides: "Settings panel UI with engine selector"
      exports: ["SettingsPanel"]
      min_lines: 150
    - path: "ui/LoadingStates.js"
      provides: "Loading indicators and progress bars"
      exports: ["LoadingStates"]
      min_lines: 100
    - path: "script.js"
      provides: "Integrated engine selection"
      contains: "RecognizerFactory.create"
    - path: "index.html"
      provides: "Settings overlay HTML"
      contains: "settings-overlay"
    - path: "styles.css"
      provides: "Settings panel and loading state styles"
      contains: ".settings-panel"
  key_links:
    - from: "script.js"
      to: "voice/recognizerFactory"
      via: "import and create() call"
      pattern: "RecognizerFactory\\.create"
    - from: "script.js"
      to: "ui/SettingsPanel"
      via: "import and render() call"
      pattern: "new SettingsPanel"
    - from: "script.js"
      to: "settings/SettingsManager"
      via: "import and instantiation"
      pattern: "new SettingsManager"
    - from: "ui/SettingsPanel.js"
      to: "settings/SettingsManager"
      via: "constructor parameter"
      pattern: "this\\.settings"
---

<objective>
Build settings UI with engine selector and integrate RecognizerFactory into script.js to enable user-controlled engine selection with loading states and visual feedback.

Purpose: Allow users to choose between Vosk and Web Speech API, see which engine is active, monitor model download progress, and switch engines without losing their script.

Output: Settings panel UI, loading state components, and fully integrated engine selection in main app.
</objective>

<execution_context>
@/Users/brent/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-engine-selection-polish/11-RESEARCH.md
@.planning/phases/11-engine-selection-polish/11-01-SUMMARY.md
@script.js
@index.html
@styles.css
</context>

<tasks>

<task type="auto">
  <name>Create LoadingStates UI components</name>
  <files>ui/LoadingStates.js</files>
  <action>
Create LoadingStates class following Pattern 4 from RESEARCH.md:

**static showDownloadProgress(container, progress) method:**
- Input: container (DOM element), progress { status, percentage, loaded, total }
- Status states: 'checking-quota', 'downloading', 'validating', 'caching', 'complete'
- For 'downloading': Show "Downloading model: {loadedMB}MB / {totalMB}MB ({percentage}%)"
- Render progress bar: `<div class="progress-bar"><div class="progress-fill" style="width: ${percentage || 0}%"></div></div>`
- Render status text below progress bar
- Use skeleton loader animation for visual feedback

**static showSpinner(container, message) method:**
- Input: container (DOM element), message (string, default: 'Initializing...')
- Render spinner with message for quick operations (<10s)

**static showEngineIndicator(engineUsed, modelCached, cacheSize, lastUpdated) method:**
- Input: engineUsed ('vosk' | 'webspeech'), modelCached (boolean), cacheSize (bytes), lastUpdated (timestamp)
- Render in #engine-indicator element (persistent in teleprompter view)
- Vosk: Show badge "Vosk (Offline)" + model status "Model cached: {sizeMB}MB ({date})"
- Web Speech: Show badge "Web Speech API (Online)"

**static showError(container, errorMessage, canRetry) method:**
- Input: container, errorMessage (string), canRetry (boolean)
- Render error icon, message, and optional retry button

Export as default: `export default LoadingStates;`

CSS classes needed (will be added to styles.css in next task):
- .loading-state, .skeleton-loader, .progress-bar, .progress-fill, .status-text
- .spinner, .engine-badge, .model-status, .error-state
  </action>
  <verify>
Create test file ui/LoadingStates.test.js and run:
```bash
npm test ui/LoadingStates.test.js
```

Test cases:
- showDownloadProgress() renders progress bar with correct percentage
- showSpinner() renders spinner with message
- showEngineIndicator() shows Vosk badge with cache info
- showEngineIndicator() shows Web Speech badge
- showError() renders error message and retry button

Manual verification in browser:
```javascript
const container = document.createElement('div');
LoadingStates.showDownloadProgress(container, { status: 'downloading', percentage: 42, loaded: 17000000, total: 40000000 });
console.log(container.innerHTML); // Should show progress bar at 42%
```
  </verify>
  <done>
LoadingStates.js exists and exports LoadingStates class with all static methods. Tests pass. Progress bars render correctly. Engine indicator shows appropriate badge.
  </done>
</task>

<task type="auto">
  <name>Create SettingsPanel UI</name>
  <files>ui/SettingsPanel.js</files>
  <action>
Create SettingsPanel class following Pattern 5 from RESEARCH.md:

**Constructor:**
- Accept settingsManager (SettingsManager instance), deviceCapability (DeviceCapability class)

**render(container) method:**
- Load current settings via settingsManager.load()
- Get device capabilities via deviceCapability.detect()
- Get engine recommendation via deviceCapability.recommendEngine()
- Render settings panel HTML:
  - Section 1: Engine Selection (radio buttons)
    - Auto (Recommended) - always available
    - Vosk (Offline) - disabled if !voskSupported with "Not supported" label
    - Web Speech API (Online) - disabled if !webSpeechSupported with "Not supported" label
    - Show recommendation.reason as help text
  - Section 2: Model Management (Vosk only, hidden if !voskSupported)
    - Model info: name, size from modelConfig
    - Cache status: "Checking cache..." (updated via _updateCacheStatus)
    - Download button: "Download for Offline Use"
    - Clear button: "Clear Cached Model"
  - Section 3: Display Settings (toggle switches)
    - Highlight toggle (highlightEnabled)
    - Mirror toggle (mirrorEnabled)
  - Close button
- Call _attachEventListeners(container)
- Call _updateCacheStatus()

**_attachEventListeners(container) method:**
- Engine radio buttons: On change, call settingsManager.set('recognitionEngine', value)
- Toggle switches: On change, call settingsManager.set(key, checked) and dispatch custom event for immediate UI update
- Download button: Call _downloadModel()
- Clear button: Call _clearModel()
- Close button: Hide overlay, dispatch 'settings-closed' event

**async _updateCacheStatus() method:**
- Get cache status from ModelCache
- If model cached: Show "Cached: {sizeMB}MB ({date})"
- If not cached: Show "Not cached - download required for offline use"

**async _downloadModel() method:**
- Create ModelLoader, call loadModel with progress callback
- Use LoadingStates.showDownloadProgress to update UI
- On success: Update cache status, show success message
- On error: Use LoadingStates.showError

**async _clearModel() method:**
- Call ModelCache.deleteModel(modelConfig.id)
- Update cache status
- Show confirmation message

Import statements:
```javascript
import SettingsManager from '../settings/SettingsManager.js';
import DeviceCapability from '../settings/DeviceCapability.js';
import ModelCache from '../model/ModelCache.js';
import ModelLoader from '../model/ModelLoader.js';
import ModelDownloader from '../model/ModelDownloader.js';
import ModelValidator from '../model/ModelValidator.js';
import { modelConfig } from '../config/modelConfig.js';
import LoadingStates from './LoadingStates.js';
```

Export as default: `export default SettingsPanel;`
  </action>
  <verify>
Create test file ui/SettingsPanel.test.js and run:
```bash
npm test ui/SettingsPanel.test.js
```

Test cases:
- render() creates settings panel HTML
- Radio buttons disabled when engine not supported
- Toggle switches update settings on change
- Cache status updated correctly
- Event listeners attached correctly

Manual browser verification:
- Open index.html
- Instantiate SettingsPanel and render
- Verify engine options show/hide based on support
- Verify toggle switches work
- Verify model management section appears only when Vosk supported
  </verify>
  <done>
SettingsPanel.js exists and exports SettingsPanel class. Tests pass. Settings panel renders with engine selector, model management (Vosk only), and display toggles. Event listeners work correctly.
  </done>
</task>

<task type="auto">
  <name>Integrate engine selection into script.js and add UI</name>
  <files>script.js, index.html, styles.css</files>
  <action>
**Update script.js:**

1. Add imports at top:
```javascript
import SettingsManager from './settings/SettingsManager.js';
import DeviceCapability from './settings/DeviceCapability.js';
import RecognizerFactory from './voice/recognizerFactory.js';
import SettingsPanel from './ui/SettingsPanel.js';
import LoadingStates from './ui/LoadingStates.js';
```

2. Replace existing voice initialization (currently hardcoded SpeechRecognizer):
- Remove: `speechRecognizer = new SpeechRecognizer(...)`
- Add settingsManager initialization: `const settingsManager = new SettingsManager();`
- Load settings: `const settings = settingsManager.load();`
- Apply settings to state: fontSize, scrollSpeed, highlightEnabled, mirrorEnabled
- Update voice toggle click handler to use RecognizerFactory:
```javascript
voiceToggle.addEventListener('click', async () => {
  if (!state.voiceEnabled) {
    state.voiceState = 'initializing';
    const enginePreference = settings.recognitionEngine || 'auto';

    try {
      const { recognizer, engineUsed, fallbackReason } = await RecognizerFactory.create(
        enginePreference,
        {
          onTranscript: handleSpeechTranscript,
          onError: handleSpeechError,
          onStateChange: handleSpeechStateChange
        },
        (progress) => {
          LoadingStates.showDownloadProgress(listeningIndicator, progress);
        }
      );

      speechRecognizer = recognizer;
      state.activeEngine = engineUsed;

      if (fallbackReason) {
        console.warn('Engine fallback:', fallbackReason);
      }

      // Update engine indicator
      LoadingStates.showEngineIndicator(engineUsed, true, 0, Date.now());

      await speechRecognizer.start();
      state.voiceEnabled = true;
      state.voiceState = 'listening';
    } catch (error) {
      console.error('Voice mode failed:', error);
      state.voiceState = 'error';
      LoadingStates.showError(listeningIndicator, error.message, true);
    }
  } else {
    // Stop voice mode
    await speechRecognizer.stop();
    state.voiceEnabled = false;
    state.voiceState = 'idle';
  }
});
```

3. Add settings button handler:
- Find or create settings button in controls
- On click: Create SettingsPanel, render into overlay
- Listen for 'settings-closed' event to reload settings

4. Add engine indicator update on state changes

**Update index.html:**

1. Add settings overlay after teleprompter-view:
```html
<div id="settings-overlay" class="overlay hidden">
  <div id="settings-container"></div>
</div>
```

2. Add engine indicator in teleprompter view:
```html
<div id="engine-indicator" class="engine-indicator"></div>
```

3. Add settings button to controls-row (or find existing placeholder)

**Update styles.css:**

1. Add settings overlay styles:
```css
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.settings-panel {
  background: #1a1a1a;
  color: #fff;
  padding: 2rem;
  border-radius: 8px;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
}

.settings-section {
  margin-bottom: 2rem;
}

.radio-group label {
  display: block;
  padding: 0.5rem;
  cursor: pointer;
}

.radio-group label.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.toggle-switch {
  display: flex;
  align-items: center;
  margin: 0.5rem 0;
}

.toggle-slider {
  width: 50px;
  height: 24px;
  background: #333;
  border-radius: 12px;
  position: relative;
  margin-right: 0.5rem;
  cursor: pointer;
}

.toggle-switch input:checked + .toggle-slider {
  background: #4CAF50;
}
```

2. Add loading states styles:
```css
.loading-state {
  padding: 1rem;
  text-align: center;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: #333;
  border-radius: 4px;
  overflow: hidden;
  margin: 1rem 0;
}

.progress-fill {
  height: 100%;
  background: #4CAF50;
  transition: width 0.3s ease;
}

.skeleton-loader {
  width: 100%;
  height: 40px;
  background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
  background-size: 200% 100%;
  animation: skeleton 1.5s ease-in-out infinite;
  border-radius: 4px;
}

@keyframes skeleton {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.engine-indicator {
  position: absolute;
  top: 4rem;
  right: 1rem;
  padding: 0.5rem 1rem;
  background: rgba(0, 0, 0, 0.7);
  border-radius: 4px;
  font-size: 0.875rem;
}

.engine-badge {
  font-weight: bold;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  margin-right: 0.5rem;
}

.engine-badge.vosk {
  background: #4CAF50;
  color: #000;
}

.engine-badge.webspeech {
  background: #2196F3;
  color: #fff;
}

.error-state {
  color: #f44336;
  padding: 1rem;
  text-align: center;
}
```

3. Add spinner animation if not already present

Preserve existing functionality:
- Manual scroll controls still work
- Font size/scroll speed adjustments still work
- Highlight toggle still works
- Mirror mode still works
- Debug mode still works
- All existing v1.1 pipeline components (WordMatcher, PositionTracker, ScrollController) unchanged

Only change: Voice mode initialization now uses RecognizerFactory instead of hardcoded SpeechRecognizer
  </action>
  <verify>
Run tests:
```bash
npm test
```

Manual browser verification:
1. Open index.html in browser with DevTools console open
2. Click Voice button
3. Verify one of:
   - If SharedArrayBuffer available: Loading state shows model download progress (Vosk)
   - If SharedArrayBuffer unavailable: Web Speech API initializes directly
4. Verify engine indicator appears showing which engine is active
5. Click settings button (or add temporary button if needed)
6. Verify settings panel appears with:
   - Engine selector (radio buttons)
   - Model management (if Vosk supported)
   - Display toggles (highlight, mirror)
7. Change engine preference, close settings
8. Disable/re-enable voice mode
9. Verify new engine used on next initialization
10. Verify script content and scroll position preserved when switching engines
11. Verify all existing features still work (manual scroll, font size, etc.)

Verify localStorage persistence:
1. Change settings
2. Reload page
3. Verify settings persisted (font size, engine preference, toggles)
  </verify>
  <done>
script.js updated with RecognizerFactory integration. index.html has settings overlay and engine indicator. styles.css has settings panel and loading state styles. Voice mode uses dynamic engine selection. Settings persist across reloads. All existing features preserved. ENGINE-01, ENGINE-02, ENGINE-04, ENGINE-05, ENGINE-06, ENGINE-07, ENGINE-08, ENGINE-09, INTEG-05 satisfied.
  </done>
</task>

</tasks>

<verification>
Full integration test:
1. Fresh browser window: `open index.html`
2. Paste script text and start teleprompter
3. Click Voice button → Verify engine initialization with loading state
4. Verify engine indicator shows active engine
5. Open settings → Verify panel renders
6. Change engine preference → Close settings
7. Disable voice → Re-enable voice → Verify new engine used
8. Reload page → Verify settings persisted
9. Test on different browsers (Chrome, Safari, Firefox) to verify fallback logic
10. Verify manual scroll still works while voice mode active
11. Verify highlight and mirror toggles work in settings
12. Verify model download UI appears when Vosk selected (if supported)

Check console for:
- No errors
- Fallback warnings if Vosk unavailable
- Engine selection logs
</verification>

<success_criteria>
- SettingsPanel UI component exists with engine selector, model management, display toggles
- LoadingStates component exists with progress bars, spinners, engine indicators
- script.js uses RecognizerFactory instead of hardcoded SpeechRecognizer
- Settings overlay accessible from teleprompter controls
- Engine indicator visible in teleprompter view showing active engine
- Settings persist in localStorage across page reloads
- Engine selection works: Auto, Vosk (if supported), Web Speech API
- Model download progress shown when loading Vosk
- Model cache status displayed in settings (if Vosk supported)
- Switching engines preserves script content and scroll position
- All existing features unchanged (manual scroll, font size, highlight, mirror, debug)
- Satisfies ENGINE-01, ENGINE-04, ENGINE-05, ENGINE-06, ENGINE-07, ENGINE-08, ENGINE-09, INTEG-05
</success_criteria>

<output>
After completion, create `.planning/phases/11-engine-selection-polish/11-02-SUMMARY.md`
</output>
