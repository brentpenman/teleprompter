---
phase: 07-scrollcontroller
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - matching/ScrollController.js
  - matching/ScrollController.test.js
autonomous: true

must_haves:
  truths:
    - "ScrollController queries PositionTracker.getConfirmedPosition() on each frame"
    - "positionToScrollTop converts word index to scroll position keeping caret at upper third"
    - "Speech pace derived from word position deltas over time"
    - "Scroll animation uses exponential smoothing (frame-rate independent)"
    - "5+ seconds silence transitions to holding state"
    - "Any forward position advance resumes tracking automatically"
  artifacts:
    - path: "matching/ScrollController.js"
      provides: "Reactive scroll controller class"
      exports: ["ScrollController"]
      min_lines: 150
    - path: "matching/ScrollController.test.js"
      provides: "TDD tests for ScrollController"
      min_lines: 100
  key_links:
    - from: "matching/ScrollController.js"
      to: "PositionTracker.getConfirmedPosition"
      via: "queries on frame tick"
      pattern: "positionTracker\\.getConfirmedPosition"
---

<objective>
Implement ScrollController with TDD - the reactive scroll component for v1.1 pipeline.

Purpose: ScrollController translates confirmed positions from PositionTracker into smooth scroll animations, keeping upcoming text at a fixed caret position and deriving speed from the user's actual speech pace.

Output: Working ScrollController class with comprehensive test suite covering position-to-scroll conversion, pace calculation, exponential smoothing animation, and tracking/holding state transitions.
</objective>

<execution_context>
@/Users/brent/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-scrollcontroller/07-RESEARCH.md
@matching/PositionTracker.js
</context>

<feature>
  <name>ScrollController Core</name>
  <files>matching/ScrollController.js, matching/ScrollController.test.js</files>
  <behavior>
    ScrollController is a class that manages scroll animation for the teleprompter.
    It is purely reactive - it queries PositionTracker for position, never stores position itself.

    Core behaviors to test:

    1. **positionToScrollTop(wordIndex)** - Pure function converting word index to scroll position
       - Input: wordIndex=0, totalWords=100, containerHeight=600, scrollHeight=2000, caretPercent=33
       - Expected: scrollTop = (0/100 * 2000) - (0.33 * 600) = 0 - 198 = 0 (clamped)
       - Input: wordIndex=50, totalWords=100, same dimensions
       - Expected: scrollTop = (50/100 * 2000) - (0.33 * 600) = 1000 - 198 = 802
       - Input: wordIndex=100, totalWords=100 (at end)
       - Expected: scrollTop = maxScroll (clamped to scrollHeight - containerHeight = 1400)

    2. **updatePace(newPosition, timestamp)** - Track speaking pace from position changes
       - Input: position 0 at t=0, position 5 at t=2000ms
       - Expected: instantPace = 5/2 = 2.5 words/sec
       - Input: consecutive call with position 10 at t=4000ms
       - Expected: pace smoothed via exponential moving average
       - Input: long gap (>5 seconds) - should be ignored
       - Input: same position repeated - no pace update

    3. **calculateSpeed()** - Convert pace to exponential smoothing speed
       - Default pace 2.5 wps at baseSpeed 5 -> returns 5
       - Pace 5 wps (double) -> returns 10 (proportional)
       - When jumpSpeed set (skip detected) -> returns jumpSpeed (15)

    4. **tick(timestamp)** - Animation frame with exponential smoothing
       - Formula: newScroll = current + (target - current) * (1 - exp(-speed * dt))
       - Frame-rate independent (same result at 30fps vs 60fps over same time)
       - Clears jumpSpeed when close to target (< 5px)

    5. **Tracking/holding state**
       - Initial state: not tracking (isTracking = false)
       - After start(): isTracking = true, onStateChange('tracking')
       - After 5+ seconds without onPositionAdvanced: isTracking = false, onStateChange('holding')
       - After onPositionAdvanced while holding: isTracking = true, onStateChange('tracking')
       - After stop(): isTracking = false, onStateChange('stopped')

    6. **onPositionAdvanced(newPosition, prevPosition)**
       - Updates pace calculation
       - Sets jumpSpeed if distance > 10 (skip detected)
       - Updates targetScrollTop
       - Resumes tracking if holding

    7. **Edge cases**
       - totalWords = 0: graceful handling
       - Container not scrollable (scrollHeight <= containerHeight): no-op
       - Reset: clears all state, scrollTop to 0
  </behavior>
  <implementation>
    ES module class following PositionTracker pattern (JSDoc types, clean API).

    Constructor: (container, positionTracker, totalWords, options)
    - container: HTMLElement (scrollable)
    - positionTracker: PositionTracker instance from Phase 6
    - totalWords: number (script word count)
    - options: { caretPercent, holdTimeout, baseSpeed, jumpSpeed, minPace, maxPace, onStateChange }

    For testing, use mock objects:
    - Mock container with scrollTop, scrollHeight, clientHeight
    - Mock positionTracker with getConfirmedPosition()
    - Mock performance.now() via timestamp parameter to tick()

    Animation loop:
    - start() begins requestAnimationFrame loop
    - tick(timestamp) queries PositionTracker, calculates target, animates
    - stop() cancels animation frame

    Key insight from research: Use exponential smoothing formula
    `position += (target - position) * (1 - exp(-speed * dt))`
    This is frame-rate independent and handles interruptions gracefully.
  </implementation>
</feature>

<verification>
```bash
# Run tests
npm test -- --testPathPattern=ScrollController

# Should see all tests pass with coverage of:
# - positionToScrollTop calculations
# - Pace tracking and smoothing
# - Exponential smoothing animation
# - State transitions (tracking/holding/stopped)
# - onPositionAdvanced handling
# - Edge cases
```
</verification>

<success_criteria>
- [ ] All tests pass (expect 15-20 tests)
- [ ] ScrollController.js exports ScrollController class
- [ ] Class queries positionTracker.getConfirmedPosition() (never stores position)
- [ ] positionToScrollTop keeps word at caret percent from top
- [ ] Pace calculation uses exponential moving average
- [ ] Exponential smoothing animation is frame-rate independent
- [ ] 5+ seconds silence triggers holding state
- [ ] Position advance resumes tracking automatically
</success_criteria>

<output>
After completion, create `.planning/phases/07-scrollcontroller/07-01-SUMMARY.md`
</output>
