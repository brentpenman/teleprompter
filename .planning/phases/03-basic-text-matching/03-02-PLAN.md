---
phase: 03-basic-text-matching
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - matching/Highlighter.js
  - styles.css
autonomous: true

must_haves:
  truths:
    - "Current matched phrase is visually highlighted"
    - "Previously matched text appears dimmed"
    - "Highlighting transitions smoothly between positions"
    - "User can toggle highlighting on/off"
  artifacts:
    - path: "matching/Highlighter.js"
      provides: "CSS Custom Highlight API wrapper"
      exports: ["Highlighter"]
    - path: "styles.css"
      provides: "Highlight styling rules"
      contains: "::highlight"
  key_links:
    - from: "matching/Highlighter.js"
      to: "CSS.highlights"
      via: "CSS Custom Highlight API"
      pattern: "CSS\\.highlights\\.set"
---

<objective>
Create the text highlighting module that visually shows the current matched position in the script.

Purpose: Visual feedback is critical for the "teleprompter follows you" experience - users need to see where the app thinks they are in the script.
Output: Highlighter module using CSS Custom Highlight API with current phrase and dimmed previous text styling
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-basic-text-matching/03-CONTEXT.md
@.planning/phases/03-basic-text-matching/03-RESEARCH.md
@styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Highlighter module with CSS Custom Highlight API</name>
  <files>matching/Highlighter.js</files>
  <action>
Create `matching/Highlighter.js` that:
1. Uses CSS Custom Highlight API for performant highlighting (no DOM manipulation)
2. Supports current phrase highlight (2-5 words)
3. Supports dimmed previous text
4. Handles smooth transitions via CSS
5. Provides enable/disable toggle

```javascript
// Highlighter using CSS Custom Highlight API
// https://developer.mozilla.org/en-US/docs/Web/API/CSS_Custom_Highlight_API

export class Highlighter {
  constructor(textElement, options = {}) {
    this.element = textElement;
    this.phraseLength = options.phraseLength || 3;  // Words to highlight
    this.enabled = options.enabled ?? true;

    // Check browser support
    this.supported = typeof CSS !== 'undefined' && 'highlights' in CSS;

    if (!this.supported) {
      console.warn('CSS Custom Highlight API not supported - highlighting disabled');
    }
  }

  // Highlight current position (word index in script)
  highlightPosition(wordIndex, scriptWords) {
    if (!this.supported || !this.enabled) {
      this.clear();
      return;
    }

    // Clear previous highlights
    CSS.highlights.clear();

    const text = this.element.textContent;
    if (!text) return;

    // Find character positions for the word at wordIndex
    const positions = this.findWordPositions(text, scriptWords);

    if (wordIndex < 0 || wordIndex >= positions.length) return;

    // Calculate phrase range (2-5 words centered on current position)
    const startWord = Math.max(0, wordIndex - Math.floor(this.phraseLength / 2));
    const endWord = Math.min(positions.length - 1, startWord + this.phraseLength - 1);

    // Create text node reference
    const textNode = this.getTextNode();
    if (!textNode) return;

    // Highlight current phrase
    try {
      const phraseRange = new Range();
      phraseRange.setStart(textNode, positions[startWord].start);
      phraseRange.setEnd(textNode, positions[endWord].end);

      const currentHighlight = new Highlight(phraseRange);
      CSS.highlights.set('current-match', currentHighlight);

      // Highlight previously read text (dimmed)
      if (startWord > 0) {
        const previousRange = new Range();
        previousRange.setStart(textNode, 0);
        previousRange.setEnd(textNode, positions[startWord - 1].end);

        const previousHighlight = new Highlight(previousRange);
        CSS.highlights.set('previous-match', previousHighlight);
      }
    } catch (err) {
      console.error('Highlight error:', err);
    }
  }

  // Find character positions for each word in the text
  findWordPositions(text, scriptWords) {
    const positions = [];
    let searchStart = 0;

    for (const word of scriptWords) {
      // Find this word in the text (case-insensitive)
      const wordLower = word.toLowerCase();
      const textLower = text.toLowerCase();
      const index = textLower.indexOf(wordLower, searchStart);

      if (index !== -1) {
        positions.push({
          start: index,
          end: index + word.length,
          word: word
        });
        searchStart = index + word.length;
      } else {
        // Word not found at expected position - try to find it anywhere
        const fallbackIndex = textLower.indexOf(wordLower);
        if (fallbackIndex !== -1) {
          positions.push({
            start: fallbackIndex,
            end: fallbackIndex + word.length,
            word: word
          });
        }
      }
    }

    return positions;
  }

  // Get the text node from the element
  getTextNode() {
    // Handle both direct text and nested text nodes
    if (this.element.firstChild?.nodeType === Node.TEXT_NODE) {
      return this.element.firstChild;
    }

    // If element has whitespace-preserved text, it might be the element itself
    // Walk through and find text nodes
    const walker = document.createTreeWalker(
      this.element,
      NodeFilter.SHOW_TEXT,
      null,
      false
    );

    return walker.nextNode();
  }

  // Clear all highlights
  clear() {
    if (this.supported) {
      CSS.highlights.delete('current-match');
      CSS.highlights.delete('previous-match');
    }
  }

  // Enable/disable highlighting
  setEnabled(enabled) {
    this.enabled = enabled;
    if (!enabled) {
      this.clear();
    }
  }

  // Check if highlighting is supported
  isSupported() {
    return this.supported;
  }
}
```

Key design decisions per CONTEXT.md:
- Highlight 2-5 words (current phrase), not single word
- Previously matched text dimmed
- Toggleable via setEnabled()
- CSS Custom Highlight API for performance (no DOM thrashing)
  </action>
  <verify>
- `cat matching/Highlighter.js` shows Highlighter class
- Class uses CSS.highlights API
- Has highlightPosition, clear, setEnabled methods
  </verify>
  <done>Highlighter module created using CSS Custom Highlight API with current phrase and previous text highlighting</done>
</task>

<task type="auto">
  <name>Task 2: Add highlight CSS rules to styles.css</name>
  <files>styles.css</files>
  <action>
Add CSS rules for the highlight pseudo-elements at the end of styles.css:

```css
/* Voice matching highlights */
::highlight(current-match) {
  background-color: rgba(100, 200, 255, 0.35);
  color: #fff;
}

::highlight(previous-match) {
  color: rgba(255, 255, 255, 0.5);
}

/* Smooth transitions for highlight changes */
#teleprompter-text {
  /* Enable smooth color transitions on text */
  transition: color 0.2s ease;
}

/* When highlighting is disabled, ensure full brightness */
.no-highlight #teleprompter-text {
  color: #f0f0f0 !important;
}
```

The highlight colors are:
- Current match: light blue tint background (visible but not harsh on dark background)
- Previous text: 50% opacity white (dimmed, already read)

Note: Do not modify existing styles, only append new rules.
  </action>
  <verify>
- `grep -A 5 "::highlight" styles.css` shows highlight rules
- Both current-match and previous-match pseudo-elements are styled
  </verify>
  <done>CSS highlight rules added for current phrase and dimmed previous text</done>
</task>

<task type="auto">
  <name>Task 3: Create test page for Highlighter</name>
  <files>test-highlighter.html</files>
  <action>
Create a standalone test page that:
1. Has sample script text
2. Allows clicking to set highlight position
3. Shows current/previous highlighting
4. Has toggle for enable/disable

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Highlighter Test</title>
  <style>
    body {
      font-family: system-ui;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      background: #1a1a2e;
      color: #f0f0f0;
    }

    h1, h3 { color: #fff; }

    .controls {
      margin-bottom: 20px;
      padding: 15px;
      background: #16213e;
      border-radius: 8px;
    }

    button {
      padding: 8px 16px;
      margin-right: 10px;
      background: #0f3460;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover { background: #1a508b; }
    button.active { background: #4a9; }

    #script-display {
      font-size: 32px;
      line-height: 1.6;
      padding: 20px;
      background: #0f0f1e;
      border-radius: 8px;
    }

    .position-slider {
      width: 100%;
      margin: 10px 0;
    }

    /* Include highlight styles */
    ::highlight(current-match) {
      background-color: rgba(100, 200, 255, 0.35);
      color: #fff;
    }

    ::highlight(previous-match) {
      color: rgba(255, 255, 255, 0.5);
    }

    #status {
      margin-top: 10px;
      font-size: 14px;
      color: #888;
    }
  </style>
</head>
<body>
  <h1>Highlighter Test</h1>

  <div class="controls">
    <h3>Position Control</h3>
    <input type="range" id="position-slider" class="position-slider" min="0" max="100" value="0">
    <div>Word: <span id="position-display">0</span> / <span id="total-words">0</span></div>

    <h3>Options</h3>
    <button id="toggle-highlight" class="active">Highlighting: ON</button>
    <button id="reset-btn">Reset to Start</button>

    <div id="status">Checking browser support...</div>
  </div>

  <div id="script-display">Welcome to our presentation today. We will discuss the importance of voice recognition technology and how it can transform the way we interact with applications. This is a demonstration of the highlighting system.</div>

  <script type="module">
    import { Highlighter } from './matching/Highlighter.js';
    import { tokenize } from './matching/textUtils.js';

    const scriptDisplay = document.getElementById('script-display');
    const positionSlider = document.getElementById('position-slider');
    const positionDisplay = document.getElementById('position-display');
    const totalWordsDisplay = document.getElementById('total-words');
    const toggleBtn = document.getElementById('toggle-highlight');
    const resetBtn = document.getElementById('reset-btn');
    const statusEl = document.getElementById('status');

    // Get script words
    const scriptText = scriptDisplay.textContent;
    const scriptWords = tokenize(scriptText);

    // Initialize highlighter
    const highlighter = new Highlighter(scriptDisplay, {
      phraseLength: 3,
      enabled: true
    });

    // Update displays
    totalWordsDisplay.textContent = scriptWords.length;
    positionSlider.max = scriptWords.length - 1;

    // Check support
    if (highlighter.isSupported()) {
      statusEl.textContent = 'CSS Custom Highlight API supported';
      statusEl.style.color = '#4a9';
    } else {
      statusEl.textContent = 'CSS Custom Highlight API NOT supported - try Chrome/Edge/Safari';
      statusEl.style.color = '#f66';
    }

    function updateHighlight() {
      const position = parseInt(positionSlider.value);
      positionDisplay.textContent = position;
      highlighter.highlightPosition(position, scriptWords);
    }

    positionSlider.addEventListener('input', updateHighlight);

    toggleBtn.addEventListener('click', () => {
      const enabled = !highlighter.enabled;
      highlighter.setEnabled(enabled);
      toggleBtn.textContent = `Highlighting: ${enabled ? 'ON' : 'OFF'}`;
      toggleBtn.classList.toggle('active', enabled);
      if (enabled) updateHighlight();
    });

    resetBtn.addEventListener('click', () => {
      positionSlider.value = 0;
      updateHighlight();
    });

    // Initial highlight
    updateHighlight();
  </script>
</body>
</html>
```

Test cases to verify:
1. Drag slider - highlight moves through text
2. Previous words become dimmed (lower opacity)
3. Current phrase (3 words) is highlighted
4. Toggle button turns highlighting on/off
5. Check browser support message
  </action>
  <verify>
- `cat test-highlighter.html` shows test page with slider control
- Page imports Highlighter module
- Includes highlight CSS rules
  </verify>
  <done>Test page created for validating Highlighter before integration</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Module check:
   - `ls matching/` shows Highlighter.js

2. CSS check:
   - `grep "::highlight" styles.css` shows highlight rules

3. Functional test:
   - Start local server: `npx serve .` or `python3 -m http.server`
   - Open test-highlighter.html in Chrome/Edge/Safari
   - Verify highlighting appears and moves with slider
   - Verify toggle works
   - Check that previous text is dimmed
</verification>

<success_criteria>
- matching/Highlighter.js exports Highlighter class
- Highlighter uses CSS Custom Highlight API (CSS.highlights)
- styles.css contains ::highlight(current-match) and ::highlight(previous-match) rules
- Current phrase highlight and previous text dimming work visually
- Toggle enable/disable works
</success_criteria>

<output>
After completion, create `.planning/phases/03-basic-text-matching/03-02-SUMMARY.md`
</output>
