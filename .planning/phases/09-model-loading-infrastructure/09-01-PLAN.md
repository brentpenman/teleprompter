---
phase: 09-model-loading-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server.js
  - src/utils/crossOriginCheck.js
autonomous: true

must_haves:
  truths:
    - "Server responds with COOP and COEP headers on all requests"
    - "crossOriginIsolated property is true when app loads"
    - "SharedArrayBuffer is available for Vosk WASM"
  artifacts:
    - path: "server.js"
      provides: "HTTPS server with cross-origin isolation headers"
      contains: "Cross-Origin-Opener-Policy"
      min_lines: 50
    - path: "src/utils/crossOriginCheck.js"
      provides: "Utility to verify cross-origin isolation at runtime"
      exports: ["checkCrossOriginIsolation"]
      min_lines: 25
  key_links:
    - from: "server.js"
      to: "browser self.crossOriginIsolated"
      via: "COOP/COEP response headers"
      pattern: "Cross-Origin-(Opener|Embedder)-Policy"
    - from: "src/utils/crossOriginCheck.js"
      to: "SharedArrayBuffer constructor"
      via: "try-catch instantiation"
      pattern: "new SharedArrayBuffer"
---

<objective>
Enable cross-origin isolation for Vosk WASM's SharedArrayBuffer requirement by configuring COOP/COEP headers and providing runtime verification.

Purpose: Vosk's WebAssembly implementation requires SharedArrayBuffer for threading, which browsers only enable in cross-origin isolated contexts. Without proper headers, Vosk initialization will fail with "SharedArrayBuffer is not defined".

Output: HTTPS server with COOP/COEP headers and utility to verify cross-origin isolation at runtime
</objective>

<execution_context>
@/Users/brent/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-model-loading-infrastructure/09-RESEARCH.md
@server.js
</context>

<tasks>

<task type="auto">
  <name>Configure COOP/COEP headers in server</name>
  <files>server.js</files>
  <action>
Add Cross-Origin-Opener-Policy and Cross-Origin-Embedder-Policy headers to the HTTPS server to enable cross-origin isolation.

In server.js, update the response headers to include:
- Cross-Origin-Opener-Policy: same-origin
- Cross-Origin-Embedder-Policy: require-corp

These headers must be set on ALL responses (HTML, JS, CSS, etc) for cross-origin isolation to work.

Implementation approach from research (Pattern 5):
- Add headers in the createServer callback before writeHead
- Apply to both successful responses (200) and error responses (404)
- Use require-corp for maximum browser compatibility (Safari doesn't support credentialless yet)

Important: Do NOT use credentialless policy â€” Safari doesn't support it. Use require-corp.
  </action>
  <verify>
Start server with `npm start`, then check headers:

```bash
curl -I https://localhost:3000/
```

Verify response includes:
- Cross-Origin-Opener-Policy: same-origin
- Cross-Origin-Embedder-Policy: require-corp

Also verify in browser DevTools Network tab that index.html and script.js both have these headers.
  </verify>
  <done>
Server responds with both COOP and COEP headers on all requests (HTML, JS, CSS). Headers visible in curl output and browser DevTools Network tab.
  </done>
</task>

<task type="auto">
  <name>Create cross-origin isolation verification utility</name>
  <files>src/utils/crossOriginCheck.js</files>
  <action>
Create a utility module that verifies cross-origin isolation is enabled and SharedArrayBuffer is available.

Implementation from research (Pattern 5):
- Export checkCrossOriginIsolation() function
- Check if self.crossOriginIsolated property exists and is true
- Verify SharedArrayBuffer is actually available via try-catch instantiation
- Return { isolated: boolean, error?: string } object

Error messages should be developer-friendly and actionable:
- "crossOriginIsolated property not available (old browser or insecure context)"
- "Cross-origin isolation not enabled. COOP/COEP headers required for SharedArrayBuffer."
- "SharedArrayBuffer not available: [error message]"

The utility should work in both browser and test environments.
  </action>
  <verify>
Create src/utils/ directory if needed:

```bash
mkdir -p src/utils
```

Test the utility in browser console after starting server:
1. Start server: npm start
2. Open https://localhost:3000 in browser
3. Open DevTools console
4. Import and run:
```javascript
import { checkCrossOriginIsolation } from './src/utils/crossOriginCheck.js';
const result = checkCrossOriginIsolation();
console.log(result);
```

Expected result: `{ isolated: true }`
  </verify>
  <done>
checkCrossOriginIsolation() returns { isolated: true } when called in browser with COOP/COEP headers enabled. Function also handles missing/disabled isolation with clear error messages.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Server includes COOP/COEP headers on all responses
2. crossOriginCheck utility confirms cross-origin isolation works
3. No console errors when loading app
4. SharedArrayBuffer is available in browser console: `typeof SharedArrayBuffer === 'function'`
</verification>

<success_criteria>
- Server.js includes Cross-Origin-Opener-Policy and Cross-Origin-Embedder-Policy headers
- Headers present on all response types (HTML, JS, CSS, 404 errors)
- crossOriginCheck.js utility exists and exports checkCrossOriginIsolation function
- Function returns { isolated: true } when COOP/COEP headers are set
- SharedArrayBuffer constructor is available in browser
- No breaking changes to existing functionality (app still loads and works)
</success_criteria>

<output>
After completion, create `.planning/phases/09-model-loading-infrastructure/09-01-SUMMARY.md`
</output>
