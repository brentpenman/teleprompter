---
phase: 10-voskrecognizer-adapter
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - voice/VoskRecognizer.js
  - voice/VoskRecognizer.test.js
autonomous: true

must_haves:
  truths:
    - "VoskRecognizer class exists with same interface as SpeechRecognizer"
    - "VoskRecognizer has start, stop, pause, resume methods"
    - "VoskRecognizer has isListening, isPaused methods"
    - "VoskRecognizer has static isSupported and getPlatform methods"
    - "VoskRecognizer constructor accepts options object with callbacks"
    - "VoskRecognizer properly manages model lifecycle (singleton pattern)"
  artifacts:
    - path: "voice/VoskRecognizer.js"
      provides: "VoskRecognizer class with SpeechRecognizer interface"
      exports: ["VoskRecognizer (default)"]
      min_lines: 100
    - path: "voice/VoskRecognizer.test.js"
      provides: "Interface compatibility tests"
      min_lines: 50
  key_links:
    - from: "voice/VoskRecognizer.js"
      to: "vosk-browser"
      via: "import * as Vosk"
      pattern: "import.*vosk-browser"
---

<objective>
Create VoskRecognizer class with identical interface to SpeechRecognizer using TDD to ensure interface compatibility. This is a foundational adapter that wraps vosk-browser to match the existing callback-based API.

Purpose: Enable drop-in replacement of Web Speech API with Vosk offline recognition without changing downstream components (WordMatcher, PositionTracker, ScrollController, AudioVisualizer).

Output: Fully tested VoskRecognizer class with interface parity to SpeechRecognizer (VOSK-01, VOSK-02 requirements).
</objective>

<execution_context>
@/Users/brent/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brent/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/10-voskrecognizer-adapter/10-RESEARCH.md
@voice/SpeechRecognizer.js
</context>

<feature>
  <name>VoskRecognizer Interface Compatibility</name>
  <files>voice/VoskRecognizer.js, voice/VoskRecognizer.test.js</files>
  <behavior>
    VoskRecognizer must implement exact same public interface as SpeechRecognizer:

    **Constructor:**
    - Input: options = { onTranscript, onError, onStateChange, lang }
    - Behavior: Stores options, initializes internal state, does NOT start recognition
    - Output: VoskRecognizer instance

    **Static Methods:**
    - isSupported() -> boolean (true if SharedArrayBuffer available and crossOriginIsolated)
    - getPlatform() -> { isIOS, isAndroid, isMobile }

    **Instance Methods:**
    - start() -> void (async, starts recognition, may throw on mic permission error)
    - stop() -> void (async, stops recognition, cleans up resources)
    - pause() -> void (pauses recognition but preserves intent to listen)
    - resume() -> void (resumes recognition after pause)
    - isListening() -> boolean (true if should be listening, even during retries)
    - isPaused() -> boolean (true if paused via visibility change)

    **Callbacks (from options):**
    - onTranscript(text: string, isFinal: boolean) - fired on interim and final results
    - onError(errorType: string, isFatal: boolean) - fired on errors
    - onStateChange(state: 'idle' | 'listening' | 'error') - fired on state changes

    **Internal State (not part of public API but needed):**
    - _shouldBeListening: boolean - intent to listen flag
    - _isPaused: boolean - paused state flag
    - _model: Model | null - Vosk model instance
    - _recognizer: KaldiRecognizer | null - Vosk recognizer instance
    - _audioContext, _source, _processor, _stream - audio pipeline components

    **Critical Difference from SpeechRecognizer:**
    - NO auto-restart logic (Vosk runs continuously, unlike Web Speech API's 60s timeout)
    - NO retry/backoff logic (Vosk doesn't have network errors)
    - Model must be loaded before start() via loadModel(modelArrayBuffer)
  </behavior>
  <implementation>
    RED phase: Write failing tests for interface compatibility
    - Test constructor accepts options and stores them
    - Test static methods (isSupported checks SharedArrayBuffer, getPlatform returns flags)
    - Test instance methods exist and have correct signatures
    - Test state management (isListening, isPaused flags)
    - Test error thrown if start() called before loadModel()
    - Mock vosk-browser to avoid actual WASM initialization

    GREEN phase: Implement class to pass tests
    - Create VoskRecognizer class with all methods
    - Implement static isSupported() checking SharedArrayBuffer and crossOriginIsolated
    - Implement static getPlatform() with same logic as SpeechRecognizer
    - Implement constructor storing options and initializing state
    - Implement loadModel(modelArrayBuffer) calling Vosk.createModel() and storing result
    - Implement start/stop/pause/resume as stubs (actual logic in Plan 02)
    - Implement isListening/isPaused returning internal flags

    REFACTOR phase: Clean up if needed
    - Add JSDoc comments matching SpeechRecognizer's style
    - Extract constants if any
    - Ensure error messages are developer-friendly
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>RED: Write failing tests for VoskRecognizer interface</name>
  <files>voice/VoskRecognizer.test.js</files>
  <action>
Create test file voice/VoskRecognizer.test.js with interface compatibility tests:

1. Install vosk-browser if not already installed:
   ```bash
   npm install vosk-browser@^0.0.8
   ```

2. Create test file with these test cases:
   - Test constructor accepts options object { onTranscript, onError, onStateChange, lang }
   - Test static isSupported() returns boolean (check SharedArrayBuffer availability)
   - Test static getPlatform() returns { isIOS, isAndroid, isMobile }
   - Test instance has start, stop, pause, resume, isListening, isPaused methods
   - Test loadModel() method exists and accepts ArrayBuffer
   - Test start() throws error if loadModel() not called first
   - Test isListening() returns false initially, true after start()
   - Test isPaused() returns false initially, true after pause()
   - Test stop() sets isListening() to false

Mock vosk-browser to avoid actual WASM initialization:
```javascript
// Mock Vosk module
jest.mock('vosk-browser', () => ({
  createModel: jest.fn(() => Promise.resolve({
    KaldiRecognizer: jest.fn(() => ({
      on: jest.fn(),
      acceptWaveform: jest.fn(),
      remove: jest.fn()
    })),
    terminate: jest.fn()
  }))
}));
```

Use same test structure as existing tests in codebase (describe/it blocks).
  </action>
  <verify>npm test -- VoskRecognizer.test.js (all tests fail as expected)</verify>
  <done>Test file exists with failing tests for all interface methods</done>
</task>

<task type="auto">
  <name>GREEN: Implement VoskRecognizer class to pass tests</name>
  <files>voice/VoskRecognizer.js</files>
  <action>
Create voice/VoskRecognizer.js implementing the interface:

1. Import vosk-browser at top of file

2. Implement static methods:
   - isSupported(): Check typeof SharedArrayBuffer !== 'undefined' && self.crossOriginIsolated
   - getPlatform(): Same logic as SpeechRecognizer (check navigator.userAgent for iOS/Android)

3. Implement constructor:
   - Accept options = { onTranscript, onError, onStateChange, lang }
   - Store this._options = options
   - Initialize state: _shouldBeListening = false, _isPaused = false
   - Initialize resources: _model = null, _recognizer = null, _audioContext = null, _source = null, _processor = null, _stream = null
   - Set this._sampleRate = 16000 (Vosk requirement from research)

4. Implement loadModel(modelArrayBuffer):
   - Call this._model = await Vosk.createModel(modelArrayBuffer)
   - Return void (async function)

5. Implement start() as stub:
   - Check if (!this._model) throw new Error('Model not loaded. Call loadModel() first.')
   - Check if (this._shouldBeListening) return (already listening)
   - Set this._shouldBeListening = true
   - Call this._options.onStateChange?.('listening')
   - Actual audio setup in Plan 02

6. Implement stop() as stub:
   - Set this._shouldBeListening = false
   - Call this._options.onStateChange?.('idle')
   - Actual cleanup in Plan 02

7. Implement pause():
   - Check if (!this._shouldBeListening) return
   - Set this._isPaused = true
   - Call this._options.onStateChange?.('idle')

8. Implement resume():
   - Check if (!this._isPaused) return
   - Set this._isPaused = false
   - Call this._options.onStateChange?.('listening')

9. Implement getters:
   - isListening(): return this._shouldBeListening && !this._isPaused
   - isPaused(): return this._isPaused

Add JSDoc comments matching SpeechRecognizer's style. Export as default.
  </action>
  <verify>npm test -- VoskRecognizer.test.js (all tests pass)</verify>
  <done>VoskRecognizer class exists with identical interface to SpeechRecognizer, all tests pass</done>
</task>

</tasks>

<verification>
1. Run tests: npm test -- VoskRecognizer.test.js
2. Import VoskRecognizer in script.js to verify it can be instantiated
3. Check that static methods work: VoskRecognizer.isSupported(), VoskRecognizer.getPlatform()
4. Verify loadModel() can be called (with mock model data)
5. Verify start() throws error if model not loaded
</verification>

<success_criteria>
- VoskRecognizer class exists with same interface as SpeechRecognizer
- All interface methods present: start, stop, pause, resume, isListening, isPaused
- Static methods work: isSupported, getPlatform
- Constructor accepts options object
- loadModel() method exists and accepts ArrayBuffer
- All tests pass (RED -> GREEN cycle complete)
- Code has JSDoc comments matching SpeechRecognizer style
- VOSK-01 requirement satisfied (interface compatibility)
</success_criteria>

<output>
After completion, create `.planning/phases/10-voskrecognizer-adapter/10-01-SUMMARY.md`
</output>
