<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeechRecognizer Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 { color: #fff; }
        .status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            font-size: 1.2rem;
        }
        .status.idle { background: #333; }
        .status.listening { background: #1a4d2e; }
        .status.retrying { background: #4d3d1a; }
        .status.error { background: #4d1a1a; }
        button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        button.start { background: #2e7d32; color: white; }
        button.stop { background: #c62828; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #log {
            background: #0d0d0d;
            padding: 1rem;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .log-entry { margin: 0.25rem 0; }
        .log-entry.transcript { color: #81c784; }
        .log-entry.interim { color: #a5d6a7; opacity: 0.7; }
        .log-entry.error { color: #ef5350; }
        .log-entry.state { color: #64b5f6; }
        .log-entry.info { color: #9e9e9e; }
    </style>
</head>
<body>
    <h1>SpeechRecognizer Test</h1>

    <div id="support-status" class="status"></div>

    <div id="controls" style="margin: 1rem 0;">
        <button id="start-btn" class="start">Start</button>
        <button id="stop-btn" class="stop" disabled>Stop</button>
    </div>

    <div id="state-status" class="status idle">State: idle</div>

    <h2>Log</h2>
    <div id="log"></div>

    <script type="module">
        import { isSupported, SpeechRecognizer } from './voice/SpeechRecognizer.js';

        const supportStatus = document.getElementById('support-status');
        const stateStatus = document.getElementById('state-status');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const log = document.getElementById('log');

        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Check browser support
        const supported = isSupported();
        supportStatus.textContent = supported
            ? 'Browser supports speech recognition'
            : 'Speech recognition NOT supported (use Chrome or Safari)';
        supportStatus.className = `status ${supported ? 'listening' : 'error'}`;

        addLog(`isSupported() returned: ${supported}`, 'info');

        if (!supported) {
            startBtn.disabled = true;
            addLog('Cannot create SpeechRecognizer - unsupported browser', 'error');
        } else {
            // Create recognizer instance
            let recognizer;

            try {
                recognizer = new SpeechRecognizer({
                    lang: 'en-US',
                    onTranscript: (text, isFinal) => {
                        if (isFinal) {
                            addLog(`Final: "${text}"`, 'transcript');
                        } else {
                            addLog(`Interim: "${text}"`, 'interim');
                        }
                    },
                    onError: (errorType, isFatal) => {
                        addLog(`Error: ${errorType} (fatal: ${isFatal})`, 'error');
                    },
                    onStateChange: (state) => {
                        addLog(`State changed: ${state}`, 'state');
                        stateStatus.textContent = `State: ${state}`;
                        stateStatus.className = `status ${state}`;
                    }
                });
                addLog('SpeechRecognizer instance created successfully', 'info');
            } catch (e) {
                addLog(`Failed to create SpeechRecognizer: ${e.message}`, 'error');
                startBtn.disabled = true;
            }

            // Button handlers
            startBtn.addEventListener('click', () => {
                addLog('Calling start()...', 'info');
                recognizer.start();
                startBtn.disabled = true;
                stopBtn.disabled = false;
            });

            stopBtn.addEventListener('click', () => {
                addLog('Calling stop()...', 'info');
                recognizer.stop();
                startBtn.disabled = false;
                stopBtn.disabled = true;
            });
        }
    </script>
</body>
</html>
